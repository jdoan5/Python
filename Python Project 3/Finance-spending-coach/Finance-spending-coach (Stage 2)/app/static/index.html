<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Finance Spending Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f2f5f7;
      --card:#ffffff;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-dark:#1d4ed8;
      --danger:#b91c1c;
      --text:#111827;
      --muted:#4b5563;
      --border:#e5e7eb;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, system-ui, -system-ui, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .page{
      max-width:1100px;
      margin:32px auto;
      padding:0 16px 32px;
    }

    h1{
      text-align:center;
      margin-bottom:8px;
      font-size:2.2rem;
    }
    .subheading{
      text-align:center;
      margin:0 0 24px;
      color:var(--muted);
      max-width:60rem;
      margin-inline:auto;
      font-size:.98rem;
    }

    .card{
      background:var(--card);
      border-radius:18px;
      padding:24px 24px 20px;
      box-shadow:0 18px 45px rgba(15,23,42,.12);
      border:1px solid #e5e7eb;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:18px 20px;
    }
    @media (max-width:900px){
      .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width:640px){
      .grid{ grid-template-columns:repeat(1, minmax(0, 1fr)); }
    }

    .field label{
      display:block;
      font-size:.82rem;
      font-weight:600;
      margin-bottom:4px;
    }
    .field small{
      display:block;
      font-size:.75rem;
      color:var(--muted);
      margin-top:4px;
    }
    .field input{
      width:100%;
      padding:8px 10px;
      border-radius:9px;
      border:1px solid var(--border);
      font-size:.9rem;
    }
    .field input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:18px 0 4px;
    }
    button{
      font:inherit;
      border-radius:999px;
      padding:7px 16px;
      border:1px solid transparent;
      cursor:pointer;
      min-width:140px;
    }
    .btn-primary{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent-dark);
    }
    .btn-primary:hover{ background:var(--accent-dark); }
    .btn-ghost{
      background:#fff;
      color:var(--muted);
      border-color:var(--border);
    }
    .btn-ghost:hover{
      background:#f9fafb;
    }
    .btn-secondary{
      background:#111827;
      color:#fff;
      border-color:#020617;
    }
    .btn-secondary:hover{
      background:#020617;
    }

    .helper-text{
      font-size:.8rem;
      color:var(--muted);
      margin-left:6px;
    }

    .error{
      margin-top:8px;
      font-size:.8rem;
      color:var(--danger);
    }

    .results-wrap{
      margin-top:18px;
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr);
      gap:16px;
    }
    @media (max-width:900px){
      .results-wrap{ grid-template-columns:1fr; }
    }

    .result-card{
      background:#ecfdf5;
      border-radius:14px;
      padding:14px 16px 14px;
      border:1px solid #bbf7d0;
    }
    .result-card h2{
      font-size:1rem;
      margin:0 0 6px;
    }
    .result-body p{
      margin:0 0 4px;
      font-size:.9rem;
    }
    .result-body ul{
      margin:4px 0 0 20px;
      padding:0;
      font-size:.9rem;
    }

    .badge-risk{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 7px;
      border-radius:999px;
      font-size:.75rem;
      margin-left:6px;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .risk-low{ background:#dcfce7; color:#166534; }
    .risk-medium{ background:#fef9c3; color:#92400e; }
    .risk-high{ background:#fee2e2; color:#b91c1c; }

    .coach-card{
      background:#eff6ff;
      border-radius:14px;
      padding:14px 16px 14px;
      border:1px solid #bfdbfe;
      font-size:.9rem;
    }
    .coach-card h2{
      font-size:1rem;
      margin:0 0 6px;
    }
    .coach-card p{ margin:0 0 4px; }
    .coach-card ul{
      margin:4px 0 0 18px;
      padding:0;
    }

    footer{
      margin-top:20px;
      text-align:center;
      font-size:.78rem;
      color:var(--muted);
    }
  </style>
</head>

<body>
<div class="page">
  <header>
    <h1>Finance Spending Coach</h1>
    <p class="subheading">
      Enter a simple monthly profile. The service estimates overspending risk, then (Stage 2)
      an AI coach explains the result and suggests next steps.
    </p>
  </header>

  <main>
    <section class="card">
      <form id="spending-form" novalidate>
        <div class="grid">
          <div class="field">
            <label for="income">Monthly income ($)</label>
            <input id="income" type="number" min="0" step="100" value="4000" required />
            <small>After tax / take-home.</small>
          </div>

          <div class="field">
            <label for="housing">Housing ($)</label>
            <input id="housing" type="number" min="0" step="50" value="1400" required />
          </div>

          <div class="field">
            <label for="food">Food &amp; groceries ($)</label>
            <input id="food" type="number" min="0" step="50" value="600" required />
          </div>

          <div class="field">
            <label for="transport">Transport ($)</label>
            <input id="transport" type="number" min="0" step="25" value="250" required />
          </div>

          <div class="field">
            <label for="shopping">Shopping ($)</label>
            <input id="shopping" type="number" min="0" step="25" value="300" required />
          </div>

          <div class="field">
            <label for="entertainment">Entertainment ($)</label>
            <input id="entertainment" type="number" min="0" step="25" value="200" required />
          </div>

          <div class="field">
            <label for="other">Other ($)</label>
            <input id="other" type="number" min="0" step="25" value="150" required />
          </div>

          <div class="field">
            <label for="savings_rate">Savings rate (%)</label>
            <input id="savings_rate" type="number" min="0" max="80" step="1" value="10" />
            <small>Approximate percentage of income saved.</small>
          </div>
        </div>

        <div class="actions">
          <button id="btn-score" type="button" class="btn-primary">
            Score my month
          </button>
          <button id="btn-reset" type="button" class="btn-ghost">
            Reset
          </button>
          <button id="btn-coach" type="button" class="btn-secondary">
            Ask AI coach
          </button>
          <span class="helper-text">
            Calls <code>/score_profile</code> or <code>/coach_profile</code> under the hood.
          </span>
        </div>

        <div id="error" class="error" aria-live="polite"></div>

        <div class="results-wrap">
          <section id="result-card" class="result-card" hidden>
            <h2>
              Result
              <span id="risk-badge" class="badge-risk risk-low" hidden>LOW</span>
            </h2>
            <div id="result-body" class="result-body"></div>
          </section>

          <section id="coach-card" class="coach-card" hidden>
            <h2>AI coach</h2>
            <div id="coach-body"></div>
          </section>
        </div>
      </form>
    </section>
  </main>

  <footer>
    Powered by FastAPI + a small logistic regression model.
    Stage 2 adds an AI coach layer (RAG/agent) on top of the score.
    Swagger docs are still available at <a href="/docs">/docs</a>.
  </footer>
</div>

<script>
  const form = document.getElementById("spending-form");
  const errorBox = document.getElementById("error");
  const resultCard = document.getElementById("result-card");
  const resultBody = document.getElementById("result-body");
  const riskBadge = document.getElementById("risk-badge");
  const coachCard = document.getElementById("coach-card");
  const coachBody = document.getElementById("coach-body");

  const btnScore = document.getElementById("btn-score");
  const btnReset = document.getElementById("btn-reset");
  const btnCoach = document.getElementById("btn-coach");

  function readNumber(id) {
    const el = document.getElementById(id);
    const v = Number(el.value || 0);
    return Number.isFinite(v) ? v : 0;
  }

  function buildPayload() {
    const income = readNumber("income");
    return {
      income: income,
      housing: readNumber("housing"),
      food: readNumber("food"),
      transport: readNumber("transport"),
      shopping: readNumber("shopping"),
      entertainment: readNumber("entertainment"),
      other: readNumber("other"),
      // API expects 0–1 fraction; UI is %.
      savings_rate: readNumber("savings_rate") / 100.0,
    };
  }

  function setRiskBadge(level) {
    riskBadge.hidden = false;
    riskBadge.classList.remove("risk-low", "risk-medium", "risk-high");
    if (level === "low") {
      riskBadge.textContent = "LOW";
      riskBadge.classList.add("risk-low");
    } else if (level === "medium") {
      riskBadge.textContent = "MEDIUM";
      riskBadge.classList.add("risk-medium");
    } else {
      riskBadge.textContent = "HIGH";
      riskBadge.classList.add("risk-high");
    }
  }

  async function postJson(path, payload) {
    const res = await fetch(path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const text = await res.text();
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${text}`);
    }
    return JSON.parse(text || "{}");
  }

  function renderScore(score) {
    // Expected shape from /score_profile:
    // { probability: float, risk_level: "low"|"medium"|"high", suggestions: [str, ...] }
    const pct = (score.probability * 100).toFixed(1);
    setRiskBadge(score.risk_level || "medium");

    let html = "";
    html += `<p>Overspending probability: <strong>${pct}%</strong>.</p>`;

    if (score.risk_level === "low") {
      html += `<p>Low risk of overspending. Nice work — keep your habits steady.</p>`;
    } else if (score.risk_level === "medium") {
      html += `<p>Moderate risk — some categories look a bit tight.</p>`;
    } else {
      html += `<p>High risk of overspending this month.</p>`;
    }

    if (Array.isArray(score.suggestions) && score.suggestions.length) {
      html += `<p><strong>Suggestions:</strong></p><ul>`;
      for (const s of score.suggestions) {
        html += `<li>${s}</li>`;
      }
      html += `</ul>`;
    }

    resultBody.innerHTML = html;
    resultCard.hidden = false;
  }

  function renderCoach(resp) {
    // Example expected shape from /coach_profile:
    // {
    //   probability: float,
    //   risk_level: "low"|"medium"|"high",
    //   suggestions: [...],
    //   coach_message: "paragraph…",
    //   coach_bullets: [...]
    // }
    const msg = resp.coach_message || "AI coach response unavailable.";
    let html = `<p>${msg}</p>`;

    if (Array.isArray(resp.coach_bullets) && resp.coach_bullets.length) {
      html += "<ul>";
      for (const b of resp.coach_bullets) {
        html += `<li>${b}</li>`;
      }
      html += "</ul>";
    }
    coachBody.innerHTML = html;
    coachCard.hidden = false;
  }

  function clearOutputs() {
    errorBox.textContent = "";
    resultCard.hidden = true;
    coachCard.hidden = true;
    resultBody.innerHTML = "";
    coachBody.innerHTML = "";
  }

  btnScore.addEventListener("click", async (ev) => {
    ev.preventDefault();
    clearOutputs();
    try {
      const payload = buildPayload();
      const data = await postJson("/score_profile", payload);
      renderScore(data);
    } catch (err) {
      console.error(err);
      errorBox.textContent =
        err instanceof Error ? err.message : "Something went wrong.";
    }
  });

  btnCoach.addEventListener("click", async (ev) => {
    ev.preventDefault();
    clearOutputs();
    try {
      const payload = buildPayload();
      const data = await postJson("/coach_profile", payload);
      // Reuse the score section plus coach section.
      renderScore(data);
      renderCoach(data);
    } catch (err) {
      console.error(err);
      errorBox.textContent =
        err instanceof Error ? err.message : "Something went wrong.";
    }
  });

  btnReset.addEventListener("click", () => {
    form.reset();
    clearOutputs();
  });
</script>
</body>
</html>